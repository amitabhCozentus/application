<p-drawer [(visible)]="visible" position="right" [modal]="true" [dismissible]="true" (onHide)="onCancel()"
    [showCloseIcon]="false" [style]="{ width: '25rem', maxWidth: '90vw' }">
    <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
            <h3 class="m-0 text-color font-semibold text-xl">Filters</h3>
        </div>
    </ng-template>

    <div class="h-full overflow-y-auto p-3" style="scrollbar-width: none; -ms-overflow-style: none;">
        <!-- Header actions -->
        <div class="flex align-items-center justify-content-left gap-8 mb-4">
            <p-button [text]="true" icon="pi pi-times" label="Clear Filters" severity="primary" size="small"
                (onClick)="onClear()"></p-button>
            <p-button label="Apply" size="small" [disabled]="!hasActiveFilters()"
                [severity]="hasActiveFilters() ? 'primary' : 'secondary'" (onClick)="onApply()"></p-button>
        </div>

        <!-- Save current + Settings -->
        <div class="flex align-items-center mb-4 w-full">
            <div class="flex-1">
                <p-button [disabled]="!hasActiveFilters()" (onClick)="showSaveFilterDialog()"
                    styleClass="w-full text-sl" label="Save Current Filter Criteria"></p-button>
            </div>
            <p-button [text]="true" icon="pi pi-cog" size="large" (onClick)="toggleSavedFilters()"></p-button>
        </div>

        <!-- Inline Save panel -->
        @if (showSaveDialog()) {
        <div class="mb-4 p-3 border-1 border-solid border-color-200 border-round">
            <div class="mb-3">
                <label class="block font-medium mb-2 text-sm">Enter a Name to Save</label>
                <input type="text" pInputText class="w-full" [(ngModel)]="saveFilterName" placeholder="Filter name" />
            </div>
            <div class="flex gap-2">
                <p-button [outlined]="true" size="small" (onClick)="cancelSaveFilter()" label="Cancel"></p-button>
                <p-button size="small" [disabled]="!canSaveFilter()" (onClick)="saveCurrentFilter()"
                    label="Save Filters"></p-button>
            </div>
            <p class="text-xs mt-2 mb-0">
                Saved Filters can be accessed under <span class="text-primary font-medium">settings</span>.
            </p>
        </div>
        }

        <!-- Saved Filters Manager -->
        @if (showSavedFiltersDialog()) {
        <div class="mb-4 p-3 border-1 border-solid border-color-200 border-round bg-surface-50">
            <div class="flex align-items-center justify-content-between mb-3">
                <h4 class="font-medium text-color m-0">Saved Filters</h4>
                <p-button [text]="true" icon="pi pi-times" size="small" (onClick)="showSavedFiltersDialog.set(false)"
                    severity="secondary" title="Close"></p-button>
            </div>

            @if (savedFilters().length === 0) {
            <div class="text-center text-color-secondary py-4">
                <i class="pi pi-filter text-3xl mb-2 block"></i>
                <p class="mb-0 text-sm">No saved filters found</p>
            </div>
            } @else {
            <div class="flex flex-column gap-2 max-h-20rem overflow-y-auto">
                @for (filter of savedFilters(); track filter.id) {
                <div
                    class="flex align-items-center justify-content-between p-2 border-round hover:bg-surface-100 transition-colors transition-duration-150">
                    <div class="flex-1">
                        <button
                            class="text-primary text-sm bg-transparent border-none cursor-pointer p-0 hover:text-primary-600 transition-colors transition-duration-150 font-medium"
                            type="button" (click)="applySavedFilter(filter)">{{ filter.name }}</button>
                        <div class="text-xs text-color-secondary mt-1">Created: {{ filter.createdDate | date:'short' }}
                        </div>
                    </div>
                    <div class="flex align-items-center gap-1">
                        <button
                            class="p-1 border-none bg-transparent cursor-pointer text-color-secondary hover:text-primary transition-colors transition-duration-150"
                            type="button" (click)="editSavedFilter(filter)" title="Edit Filter"><i
                                class="pi pi-pencil text-xs"></i></button>
                        <button
                            class="p-1 border-none bg-transparent cursor-pointer text-color-secondary hover:text-red-500 transition-colors transition-duration-150"
                            type="button" (click)="confirmDelete(filter)" title="Delete Filter"><i
                                class="pi pi-trash text-xs"></i></button>
                    </div>
                </div>
                }
            </div>
            }
        </div>
        }

        <!-- Shipment Status -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Status Type</label>
            <p-select [options]="statusOptions" optionLabel="label" optionValue="value"
                [(ngModel)]="model.shipmentStatus" placeholder="Select" [showClear]="true"
                styleClass="w-full"></p-select>
        </div>

        <!-- CSR -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Customer Service Representative</label>
            <p-autoComplete [(ngModel)]="model.csr" [suggestions]="csrSuggestions"
                (completeMethod)="onSuggestCsr($event)" field="name" [multiple]="true" [dropdown]="false"
                [forceSelection]="false" placeholder="Type CSR Name" styleClass="w-full"
                inputStyleClass="w-full"></p-autoComplete>
            <small class="text-500" *ngIf="csrSuggestions?.length === 0 && csrQueryLength >= 3">No results found</small>
        </div>

        <!-- LSP (4PL only) -->
        <div class="mb-2" *ngIf="model.is4pl">
            <label class="block text-600 text-xs mb-1">LSP Representative Name</label>
            <p-autoComplete [(ngModel)]="model.lsp" [suggestions]="lspSuggestions"
                (completeMethod)="onSuggestLsp($event)" field="name" [multiple]="true"
                placeholder="Type LSP Representative Name" styleClass="w-full"
                inputStyleClass="w-full"></p-autoComplete>
            <small class="text-500" *ngIf="lspSuggestions?.length === 0 && lspQueryLength >= 3">No results found</small>
        </div>

        <!-- Mode of Transport -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Mode of Transport</label>
            <p-multiSelect [options]="modesOptions" [(ngModel)]="model.modes" display="chip" placeholder="Select"
                styleClass="w-full"></p-multiSelect>
        </div>

        <!-- Origin Region/Country/Port/Receipt -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Origin Region</label>
            <p-multiSelect [options]="regionOptions" [(ngModel)]="model.originRegion" display="chip"
                placeholder="Select" [filter]="true" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Origin Country</label>
            <p-multiSelect [options]="countryOptions" [(ngModel)]="model.originCountry" display="chip"
                placeholder="Select" [filter]="true" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Origin Port</label>
            <p-autoComplete [(ngModel)]="model.originPorts" [suggestions]="portSuggestions"
                (completeMethod)="onSuggestPorts($event)" [multiple]="true" field="name" placeholder="Type 3+ chars"
                styleClass="w-full" inputStyleClass="w-full">
                <ng-template let-item pTemplate="item">{{ item.name }} ({{ item.code }})</ng-template>
                <ng-template let-item pTemplate="selectedItem">{{ item.name }} ({{ item.code }})</ng-template>
            </p-autoComplete>
            <small class="text-500" *ngIf="portSuggestions?.length === 0 && portQueryLength >= 3">No results
                found</small>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Place of Receipt</label>
            <p-autoComplete [(ngModel)]="model.placeOfReceipt" [suggestions]="placeSuggestions"
                (completeMethod)="onSuggestPlaces($event)" [multiple]="true" field="name" placeholder="Type 3+ chars"
                styleClass="w-full" inputStyleClass="w-full">
                <ng-template let-item pTemplate="item">{{ item.name }} ({{ item.code }})</ng-template>
                <ng-template let-item pTemplate="selectedItem">{{ item.name }} ({{ item.code }})</ng-template>
            </p-autoComplete>
            <small class="text-500" *ngIf="placeSuggestions?.length === 0 && placeQueryLength >= 3">No results
                found</small>
        </div>

        <!-- Destination Region/Country/Port/Delivery -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Destination Region</label>
            <p-multiSelect [options]="regionOptions" [(ngModel)]="model.destinationRegion" display="chip"
                placeholder="Select" [filter]="true" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Destination Country</label>
            <p-multiSelect [options]="countryOptions" [(ngModel)]="model.destinationCountry" display="chip"
                placeholder="Select" [filter]="true" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Destination Port</label>
            <p-autoComplete [(ngModel)]="model.destinationPorts" [suggestions]="portSuggestions"
                (completeMethod)="onSuggestPorts($event)" [multiple]="true" field="name" placeholder="Type 3+ chars"
                styleClass="w-full" inputStyleClass="w-full">
                <ng-template let-item pTemplate="item">{{ item.name }} ({{ item.code }})</ng-template>
                <ng-template let-item pTemplate="selectedItem">{{ item.name }} ({{ item.code }})</ng-template>
            </p-autoComplete>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Place of Delivery</label>
            <p-autoComplete [(ngModel)]="model.placeOfDelivery" [suggestions]="placeSuggestions"
                (completeMethod)="onSuggestPlaces($event)" [multiple]="true" field="name" placeholder="Type 3+ chars"
                styleClass="w-full" inputStyleClass="w-full">
                <ng-template let-item pTemplate="item">{{ item.name }} ({{ item.code }})</ng-template>
                <ng-template let-item pTemplate="selectedItem">{{ item.name }} ({{ item.code }})</ng-template>
            </p-autoComplete>
        </div>

        <!-- Carrier/Vessel/Flight -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Carrier (Ocean/Air)</label>
            <p-multiSelect [options]="carrierOptions" [(ngModel)]="model.carriers" display="chip" placeholder="Select"
                [filter]="true" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Vessel Name</label>
            <p-autoComplete [(ngModel)]="model.vesselNames" [suggestions]="vesselSuggestions"
                (completeMethod)="onSuggestVessels($event)" [multiple]="true" field="name" placeholder="Type 3+ chars"
                styleClass="w-full" inputStyleClass="w-full"></p-autoComplete>
        </div>
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Flight Number</label>
            <p-autoComplete [(ngModel)]="model.flightNumbers" [suggestions]="flightSuggestions"
                (completeMethod)="onSuggestFlights($event)" [multiple]="true" field="name" placeholder="Type 2+ chars"
                styleClass="w-full" inputStyleClass="w-full"></p-autoComplete>
        </div>

        <!-- Cargo/Hazardous -->
        <div class="mb-2">
            <label class="block text-600 text-xs mb-1">Cargo Type</label>
            <p-multiSelect [options]="cargoTypeOptions" [(ngModel)]="model.cargoTypes" display="chip"
                placeholder="Select" styleClass="w-full"></p-multiSelect>
        </div>
        <div class="mb-1">
            <label class="block text-600 text-xs mb-1">Hazardous Material</label>
            <p-select [options]="hazardousOptions" optionLabel="label" optionValue="value" [(ngModel)]="model.hazardous"
                placeholder="Select" [showClear]="true" styleClass="w-full"></p-select>
        </div>
    </div>
</p-drawer>
