<div class="grid m-2" id="petaManager">
    <div class="col-12">
        <div class="grid">
            <div class="col-12">
                <p-table #petaTable [value]="companies || []" [(selection)]="selectedCompanies" [paginator]="true" [rows]="pageSize"
                    [rowsPerPageOptions]="[10,25,50]" [totalRecords]="totalRecords" editMode="row" dataKey="companyCode"
                    [columns]="petaTableHeaders" [resizableColumns]="true" [reorderableColumns]="true"
                    [showCurrentPageReport]="true" [filterDelay]="0" [rowHover]="true"
                    [currentPageReportTemplate]="'LBL.TABLE.PAGE_REPORT' | translate" [lazy]="true" selectionMode="multiple"
                    styleClass="p-datatable-customers p-datatable-striped"
                    [globalFilterFields]="['companyName','companyCode','updatedBy']" (onLazyLoad)="onLazyLoad($event)"
                    (selectionChange)="onSelectionChange($event)" (onHeaderCheckboxToggle)="onHeaderCheckboxToggle($event)">

                    <!-- Caption -->
                    <ng-template pTemplate="caption">
                        <div class="flex justify-content-between align-items-center mb-3">
                            <div class="w-full md:w-30rem">
                                <app-common-table-search [value]="searchTerm" (valueChange)="searchTerm = $event"
                                    (search)="onSearch()" (clear)="refresh()"></app-common-table-search>
                            </div>
                            <div class="peta-global-panel flex align-items-center gap-3">
                                <span class="font-semibold">{{ 'LBL.PETA_CALLING' | translate }}</span>
                                <div class="flex align-items-center gap-2 " [ngClass]="{ 'panel-disabled': isRadioDisabled }">
                                    <p-radiobutton name="petaGlobal" inputId="petaYes" value="Yes"
                                        [(ngModel)]="petaGlobal" [disabled]="isRadioDisabled"></p-radiobutton>
                                    <label for="petaYes">{{ 'LBL.YES' | translate }}</label>
                                    <p-radiobutton name="petaGlobal" inputId="petaNo" value="No"
                                        [(ngModel)]="petaGlobal" [disabled]="isRadioDisabled"></p-radiobutton>
                                    <label for="petaNo">{{ 'LBL.NO' | translate }}</label>
                                </div>
                                <button pButton label="{{ 'LBL.BUTTON.SAVE' | translate }}" class="p-button-primary save-btn"
                                    [disabled]="isSaveDisabled" (click)="saveGlobal()"></button>
                            </div>
                        </div>
                    </ng-template>

                    <!-- Header -->
                    <ng-template pTemplate="header" let-columns>
                        <tr>
                            @if (canEdit) {
                            <th> <p-tableHeaderCheckbox /> </th>
                            <th>{{ 'LBL.ACTION' | translate }}</th>
                            }
                            @for (col of columns; track col.field) {
                            <th [pSortableColumn]="col.sortable ? col.field : null">
                                {{ col.header | translate }}
                                @if (col.sortable) {
                                <p-sortIcon [field]="col.field" />
                                }
                                @if (col.type === 'date') {
                                <p-columnFilter type="date" [field]="col.field" display="menu" [showMatchModes]="true">
                                    <ng-template #filtericon>
                                        <app-common-table-filter [field]="col.field" [table]="petaTable"></app-common-table-filter>
                                    </ng-template>
                                </p-columnFilter>
                                } @else if (col.filter) {
                                <p-columnFilter [type]="col.type" [field]="col.field" display="menu">
                                    <ng-template #filtericon>
                                        <app-common-table-filter [field]="col.field" [table]="petaTable"></app-common-table-filter>
                                    </ng-template>
                                </p-columnFilter>
                                }
                            </th>
                            }
                        </tr>
                    </ng-template>

                    <!-- Body -->
                    <ng-template pTemplate="body" let-row let-ri="rowIndex" let-columns="columns">
                        <tr>
                            @if (canEdit) {
                            <td>
                                <p-tableCheckbox [value]="row" />
                            </td>
                            <td class="white-space-nowrap">
                                @if (!row?.isEditing) {
                                <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-text"
                                    (click)="startEdit(row)"></button>
                                } @else {
                                <button pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-text mr-2"
                                    (click)="saveRow(row)"></button>
                                <button pButton pRipple icon="pi pi-times" class="p-button-rounded p-button-text"
                                    (click)="cancelEdit(row)"></button>
                                }
                            </td>
                            }

                            <!-- Reusable frequency selector template -->
                            <ng-template #freqSelect let-model="model" let-options="options" let-row="row"
                                let-disabled="disabled">
                                <p-select [options]="options" [ngModel]="row[model]"
                                    (ngModelChange)="row[model] = $event" optionLabel="label" optionValue="value"
                                    appendTo="body" style="width:13.75rem" [panelStyle]="{ width: '13.75rem' }"
                                    [disabled]="disabled" [showClear]="false">
                                </p-select>
                            </ng-template>

                            @for (col of columns; track col.field) {
                            <td>
                                @switch (col.field) {
                                @case ('companyName') { {{ row?.companyName }} }
                                @case ('companyCode') { {{ row?.companyCode }} }
                                @case ('petaEnabled') {
                                <p-toggleswitch [(ngModel)]="row.petaEnabled"
                                    [disabled]="!row?.isEditing"></p-toggleswitch>
                                }
                                @case ('oceanFrequencyId') {
                                <ng-container [ngTemplateOutlet]="freqSelect"
                                    [ngTemplateOutletContext]="{ model: 'oceanFrequencyId', options: oceanFrequencyOptions || [], row: row, disabled: (!row?.isEditing || !row?.petaEnabled) }">
                                </ng-container>
                                }
                                @case ('airFrequencyId') {
                                <ng-container [ngTemplateOutlet]="freqSelect"
                                    [ngTemplateOutletContext]="{ model: 'airFrequencyId', options: airFrequencyOptions || [], row: row, disabled: (!row?.isEditing || !row?.petaEnabled) }">
                                </ng-container>
                                }
                                @case ('railRoadFrequencyId') {
                                <ng-container [ngTemplateOutlet]="freqSelect"
                                    [ngTemplateOutletContext]="{ model: 'railRoadFrequencyId', options: railRoadFrequencyOptions || [], row: row, disabled: (!row?.isEditing || !row?.petaEnabled) }">
                                </ng-container>
                                }
                                @case ('updatedBy') { {{ row?.updatedBy }} }
                                @case ('updatedOn') { {{ row?.updatedOn | date: dateTimeFormat }} }
                                }
                            </td>
                            }
                        </tr>
                    </ng-template>

                    <!-- Empty -->
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td [attr.colspan]="(petaTableHeaders?.length || 0) + (canEdit ? 2 : 0)"
                                class="text-center">No premium companies found.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
</div>

<app-toast-component></app-toast-component>
